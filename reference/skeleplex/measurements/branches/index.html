
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../angles/">
      
      
        <link rel="next" href="../fit_surface/">
      
      
        
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>branches - Skeleplex</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.618322db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#skeleplex.measurements.branches" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="Skeleplex" class="md-header__button md-logo" aria-label="Skeleplex" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Skeleplex
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              branches
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Skeleplex" class="md-nav__button md-logo" aria-label="Skeleplex" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Skeleplex
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Code Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Code Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    skeleplex
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    skeleplex
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../app/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    app
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_1_1" id="__nav_2_1_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    app
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../app/_app/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    _app
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../app/_constants/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    _constants
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../app/_curate/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    _curate
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../app/_data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    _data
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../app/_utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    _utils
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../app/_viewer_controller/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    _viewer_controller
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../app/actions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    actions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_1_8" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../app/cellier/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    cellier
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_1_1_8" id="__nav_2_1_1_8_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_2_1_1_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_1_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    cellier
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../app/cellier/utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    utils
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../app/functions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    functions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_1_10" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../app/qt/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    qt
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_1_1_10" id="__nav_2_1_1_10_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_2_1_1_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_1_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    qt
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../app/qt/app_controls/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    app_controls
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../app/qt/auxiliary_views/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    auxiliary_views
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../app/qt/flat_group_box/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    flat_group_box
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../app/qt/main_viewer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    main_viewer
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../app/qt/styles/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    styles
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../app/qt/window/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    window
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../data/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    data
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_1_2" id="__nav_2_1_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    data
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/bifurcating_tree/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    bifurcating_tree
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/fractal_trees/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fractal_trees
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/skeleton_image/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    skeleton_image
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/skeletons/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    skeletons
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/tubes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    tubes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    utils
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/y_junctions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    y_junctions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../graph/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    graph
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_1_3" id="__nav_2_1_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    graph
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../graph/break_detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    break_detection
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../graph/constants/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    constants
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../graph/image_to_graph/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    image_to_graph
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../graph/image_to_graph_lazy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    image_to_graph_lazy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../graph/modify_graph/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    modify_graph
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../graph/sample/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    sample
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../graph/skeleton_graph/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    skeleton_graph
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../graph/spline/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    spline
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../graph/utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    utils
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_4" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    measurements
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_1_4" id="__nav_2_1_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_1_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    measurements
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../angles/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    angles
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    branches
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    branches
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.add_file_to_graph" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;add_file_to_graph
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.add_measurements_from_h5_to_graph" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;add_measurements_from_h5_to_graph
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" add_measurements_from_h5_to_graph">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.add_measurements_from_h5_to_graph(graph_path)" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-parameter"></code>&nbsp;graph_path
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.add_measurements_from_h5_to_graph(input_path)" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-parameter"></code>&nbsp;input_path
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.filter_and_segment_lumen" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;filter_and_segment_lumen
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" filter_and_segment_lumen">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.filter_and_segment_lumen(data_path)" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-parameter"></code>&nbsp;data_path
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.filter_and_segment_lumen(save_path)" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-parameter"></code>&nbsp;save_path
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.filter_and_segment_lumen(sam_checkpoint_path)" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-parameter"></code>&nbsp;sam_checkpoint_path
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.filter_and_segment_lumen(resnet_predictor)" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-parameter"></code>&nbsp;resnet_predictor
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.filter_and_segment_lumen(eccentricity_thresh)" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-parameter"></code>&nbsp;eccentricity_thresh
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.filter_and_segment_lumen(circularity_thresh)" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-parameter"></code>&nbsp;circularity_thresh
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.filter_and_segment_lumen(find_lumen)" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-parameter"></code>&nbsp;find_lumen
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.filter_and_segment_lumen(sam_quality_threshold)" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-parameter"></code>&nbsp;sam_quality_threshold
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.filter_and_segment_lumen(segmentation_key)" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-parameter"></code>&nbsp;segmentation_key
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.filter_file_for_iterative_lumens" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;filter_file_for_iterative_lumens
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" filter_file_for_iterative_lumens">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.filter_file_for_iterative_lumens(args)" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-parameter"></code>&nbsp;args
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.filter_for_iterative_lumens" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;filter_for_iterative_lumens
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" filter_for_iterative_lumens">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.filter_for_iterative_lumens(data_path)" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-parameter"></code>&nbsp;data_path
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.filter_for_iterative_lumens(save_path)" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-parameter"></code>&nbsp;save_path
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.find_lumen_in_slice" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;find_lumen_in_slice
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.fix_only_lumen" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;fix_only_lumen
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.lumen_touches_background" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;lumen_touches_background
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" lumen_touches_background">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.lumen_touches_background(label_slice)" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-parameter"></code>&nbsp;label_slice
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fit_surface/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fit_surface
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../graph_properties/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    graph_properties
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lumen_classifier/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    lumen_classifier
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    utils
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../skeleton/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    skeleton
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_1_5" id="__nav_2_1_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    skeleton
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../skeleton/_chunked_label/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    _chunked_label
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../skeleton/_chunked_upscale/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    _chunked_upscale
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../skeleton/_segment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    _segment
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../skeleton/_skeletonize/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    _skeletonize
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../skeleton/_upscale/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    _upscale
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../skeleton/_utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    _utils
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../skeleton/distance_field/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    distance_field
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_6" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../utils/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    utils
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_1_6" id="__nav_2_1_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    utils
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/_chunked/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    _chunked
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/_geometry/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    _geometry
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_7" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../visualize/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    visualize
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_1_7" id="__nav_2_1_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    visualize
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../visualize/_color/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    _color
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../visualize/spline/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    spline
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.add_file_to_graph" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;add_file_to_graph
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.add_measurements_from_h5_to_graph" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;add_measurements_from_h5_to_graph
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" add_measurements_from_h5_to_graph">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.add_measurements_from_h5_to_graph(graph_path)" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-parameter"></code>&nbsp;graph_path
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.add_measurements_from_h5_to_graph(input_path)" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-parameter"></code>&nbsp;input_path
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.filter_and_segment_lumen" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;filter_and_segment_lumen
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" filter_and_segment_lumen">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.filter_and_segment_lumen(data_path)" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-parameter"></code>&nbsp;data_path
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.filter_and_segment_lumen(save_path)" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-parameter"></code>&nbsp;save_path
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.filter_and_segment_lumen(sam_checkpoint_path)" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-parameter"></code>&nbsp;sam_checkpoint_path
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.filter_and_segment_lumen(resnet_predictor)" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-parameter"></code>&nbsp;resnet_predictor
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.filter_and_segment_lumen(eccentricity_thresh)" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-parameter"></code>&nbsp;eccentricity_thresh
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.filter_and_segment_lumen(circularity_thresh)" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-parameter"></code>&nbsp;circularity_thresh
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.filter_and_segment_lumen(find_lumen)" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-parameter"></code>&nbsp;find_lumen
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.filter_and_segment_lumen(sam_quality_threshold)" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-parameter"></code>&nbsp;sam_quality_threshold
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.filter_and_segment_lumen(segmentation_key)" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-parameter"></code>&nbsp;segmentation_key
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.filter_file_for_iterative_lumens" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;filter_file_for_iterative_lumens
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" filter_file_for_iterative_lumens">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.filter_file_for_iterative_lumens(args)" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-parameter"></code>&nbsp;args
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.filter_for_iterative_lumens" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;filter_for_iterative_lumens
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" filter_for_iterative_lumens">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.filter_for_iterative_lumens(data_path)" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-parameter"></code>&nbsp;data_path
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.filter_for_iterative_lumens(save_path)" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-parameter"></code>&nbsp;save_path
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.find_lumen_in_slice" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;find_lumen_in_slice
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.fix_only_lumen" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;fix_only_lumen
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.lumen_touches_background" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;lumen_touches_background
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" lumen_touches_background">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#skeleplex.measurements.branches.lumen_touches_background(label_slice)" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-parameter"></code>&nbsp;label_slice
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<div class="doc doc-object doc-module">



<h1 id="skeleplex.measurements.branches" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">skeleplex.measurements.branches</span>


</h1>

    <div class="doc doc-contents first">












<p><span class="doc-section-title">Functions:</span></p>
    <ul>
          <li class="doc-section-item field-body">
            <b><code><a class="autorefs autorefs-internal" title="            add_file_to_graph (skeleplex.measurements.branches.add_file_to_graph)" href="#skeleplex.measurements.branches.add_file_to_graph">add_file_to_graph</a></code></b>
            –
            <div class="doc-md-description">
              <p>Process a single HDF5 file.</p>
            </div>
          </li>
          <li class="doc-section-item field-body">
            <b><code><a class="autorefs autorefs-internal" title="            add_measurements_from_h5_to_graph (skeleplex.measurements.branches.add_measurements_from_h5_to_graph)" href="#skeleplex.measurements.branches.add_measurements_from_h5_to_graph">add_measurements_from_h5_to_graph</a></code></b>
            –
            <div class="doc-md-description">
              <p>Add measurements from HDF5 files to the skeleton graph.</p>
            </div>
          </li>
          <li class="doc-section-item field-body">
            <b><code><a class="autorefs autorefs-internal" title="            filter_and_segment_lumen (skeleplex.measurements.branches.filter_and_segment_lumen)" href="#skeleplex.measurements.branches.filter_and_segment_lumen">filter_and_segment_lumen</a></code></b>
            –
            <div class="doc-md-description">
              <p>Filter and segment the lumen in the image slices.</p>
            </div>
          </li>
          <li class="doc-section-item field-body">
            <b><code><a class="autorefs autorefs-internal" title="            filter_file_for_iterative_lumens (skeleplex.measurements.branches.filter_file_for_iterative_lumens)" href="#skeleplex.measurements.branches.filter_file_for_iterative_lumens">filter_file_for_iterative_lumens</a></code></b>
            –
            <div class="doc-md-description">
              <p>Filter a single HDF5 file for iterative lumens.</p>
            </div>
          </li>
          <li class="doc-section-item field-body">
            <b><code><a class="autorefs autorefs-internal" title="            filter_for_iterative_lumens (skeleplex.measurements.branches.filter_for_iterative_lumens)" href="#skeleplex.measurements.branches.filter_for_iterative_lumens">filter_for_iterative_lumens</a></code></b>
            –
            <div class="doc-md-description">
              <p>Filter for iterative lumens across multiple files in parallel.</p>
            </div>
          </li>
          <li class="doc-section-item field-body">
            <b><code><a class="autorefs autorefs-internal" title="            find_lumen_in_slice (skeleplex.measurements.branches.find_lumen_in_slice)" href="#skeleplex.measurements.branches.find_lumen_in_slice">find_lumen_in_slice</a></code></b>
            –
            <div class="doc-md-description">
              <p>Find lumen and branch labels in a single 2D image slice.</p>
            </div>
          </li>
          <li class="doc-section-item field-body">
            <b><code><a class="autorefs autorefs-internal" title="            fix_only_lumen (skeleplex.measurements.branches.fix_only_lumen)" href="#skeleplex.measurements.branches.fix_only_lumen">fix_only_lumen</a></code></b>
            –
            <div class="doc-md-description">
              <p>Fix segmentation slices containing only lumen.</p>
            </div>
          </li>
          <li class="doc-section-item field-body">
            <b><code><a class="autorefs autorefs-internal" title="            lumen_touches_background (skeleplex.measurements.branches.lumen_touches_background)" href="#skeleplex.measurements.branches.lumen_touches_background">lumen_touches_background</a></code></b>
            –
            <div class="doc-md-description">
              <p>Check if lumen touches background in a label slice.</p>
            </div>
          </li>
    </ul>





  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="skeleplex.measurements.branches.add_file_to_graph" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">add_file_to_graph</span>


</h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">add_file_to_graph</span><span class="p">(</span><span class="n"><span title="skeleplex.measurements.branches.add_file_to_graph(file)">file</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Process a single HDF5 file.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>skeleplex/measurements/branches.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_file_to_graph</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process a single HDF5 file.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">image_slices</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">][:]</span>
            <span class="n">segmentation_slices</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;segmentation&quot;</span><span class="p">][:]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="n">start_node</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">end_node</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">tissue_radius_branch</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lumen_radius_branch</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">minor_axis_branch</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">major_axis_branch</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">total_area_branch</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">slice_index</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">segmentation_slice</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
        <span class="nb">zip</span><span class="p">(</span><span class="n">image_slices</span><span class="p">,</span> <span class="n">segmentation_slices</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">segmentation_slice</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">segmentation_slice</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">fix_only_lumen</span><span class="p">(</span>
                <span class="n">segmentation_slice</span>
            <span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fixing </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">, slice </span><span class="si">{</span><span class="n">slice_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">segmentation_slice</span><span class="p">[</span><span class="n">segmentation_slice</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">segmentation_slices</span><span class="p">[</span><span class="n">slice_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">segmentation_slice</span>

            <span class="n">label_slice</span> <span class="o">=</span> <span class="n">ski</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">label</span><span class="p">((</span><span class="n">segmentation_slice</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
            <span class="n">props</span> <span class="o">=</span> <span class="n">ski</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">regionprops</span><span class="p">(</span><span class="n">label_slice</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">props</span><span class="p">:</span>
                <span class="n">minor_axis</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">minor_axis_length</span>
                <span class="n">major_axis</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">major_axis_length</span>
                <span class="n">total_area</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">area</span>
                <span class="n">minor_axis_branch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">minor_axis</span><span class="p">)</span>
                <span class="n">major_axis_branch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">major_axis</span><span class="p">)</span>
                <span class="n">total_area_branch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total_area</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">segmentation_slice</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lumen_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">segmentation_slice</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                <span class="n">tissue_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">segmentation_slice</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

                <span class="n">lumen_props</span> <span class="o">=</span> <span class="n">ski</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">regionprops</span><span class="p">(</span><span class="n">ski</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">lumen_label</span><span class="p">))</span>
                <span class="n">tissue_props</span> <span class="o">=</span> <span class="n">ski</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">regionprops</span><span class="p">(</span><span class="n">ski</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">tissue_label</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">lumen_props</span> <span class="ow">and</span> <span class="n">tissue_props</span><span class="p">:</span>
                    <span class="n">lumen_area</span> <span class="o">=</span> <span class="n">lumen_props</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">area</span>
                    <span class="n">tissue_area</span> <span class="o">=</span> <span class="n">tissue_props</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">area</span>
                    <span class="n">total_area</span> <span class="o">=</span> <span class="n">lumen_area</span> <span class="o">+</span> <span class="n">tissue_area</span>
                    <span class="n">total_radius</span> <span class="o">=</span> <span class="n">radius_from_area</span><span class="p">(</span><span class="n">total_area</span><span class="p">)</span>
                    <span class="n">lumen_radius</span> <span class="o">=</span> <span class="n">radius_from_area</span><span class="p">(</span><span class="n">lumen_area</span><span class="p">)</span>
                    <span class="n">tissue_radius</span> <span class="o">=</span> <span class="n">total_radius</span> <span class="o">-</span> <span class="n">lumen_radius</span>
                    <span class="n">tissue_radius_branch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tissue_radius</span><span class="p">)</span>
                    <span class="n">lumen_radius_branch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lumen_radius</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># no tissue label, full region is tissue</span>
                <span class="n">tissue_radius_branch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">minor_axis</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">lumen_radius_branch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># completely closed (no lumen)</span>
            <span class="n">label_slice</span> <span class="o">=</span> <span class="n">ski</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">label</span><span class="p">((</span><span class="n">segmentation_slice</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
            <span class="n">props</span> <span class="o">=</span> <span class="n">ski</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">regionprops</span><span class="p">(</span><span class="n">label_slice</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">props</span><span class="p">:</span>
                <span class="n">minor_axis</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">minor_axis_length</span>
                <span class="n">major_axis</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">major_axis_length</span>
                <span class="n">total_area</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">area</span>
                <span class="n">minor_axis_branch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">minor_axis</span><span class="p">)</span>
                <span class="n">major_axis_branch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">major_axis</span><span class="p">)</span>
                <span class="n">total_area_branch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total_area</span><span class="p">)</span>
                <span class="n">tissue_radius_branch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">minor_axis</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">lumen_radius_branch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">start_node</span><span class="p">,</span>
        <span class="n">end_node</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lumen_radius_branch</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lumen_radius_branch</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tissue_radius_branch</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">tissue_radius_branch</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">total_area_branch</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">total_area_branch</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">minor_axis_branch</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">minor_axis_branch</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">major_axis_branch</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">major_axis_branch</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="skeleplex.measurements.branches.add_measurements_from_h5_to_graph" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">add_measurements_from_h5_to_graph</span>


</h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">add_measurements_from_h5_to_graph</span><span class="p">(</span><span class="n"><a class="autorefs autorefs-internal" title="graph_path (skeleplex.measurements.branches.add_measurements_from_h5_to_graph(graph_path))" href="#skeleplex.measurements.branches.add_measurements_from_h5_to_graph(graph_path)">graph_path</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-internal" title="input_path (skeleplex.measurements.branches.add_measurements_from_h5_to_graph(input_path))" href="#skeleplex.measurements.branches.add_measurements_from_h5_to_graph(input_path)">input_path</a></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Add measurements from HDF5 files to the skeleton graph.</p>
<p>The slice names need to be in the format:</p>
<p>{base}<em>{name}</em>{start_node}_{end_node}.h5</p>
<p>Valid files are usually generated using the sample_slices_from_graph function from
the SkeletonGraph class. Its highly advised to use the filtering
functions first.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
<h3 id="skeleplex.measurements.branches.add_measurements_from_h5_to_graph(graph_path)" class="doc doc-heading doc-heading-parameter">              <b><code>graph_path</code></b>
</h3>              (<code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>)
          –
          <div class="doc-md-description">
            <p>Path to the skeleton graph JSON file.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
<h3 id="skeleplex.measurements.branches.add_measurements_from_h5_to_graph(input_path)" class="doc doc-heading doc-heading-parameter">              <b><code>input_path</code></b>
</h3>              (<code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>)
          –
          <div class="doc-md-description">
            <p>Path to the directory containing HDF5 files with the segmented slices.</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Returns:</span></p>
    <ul>
        <li class="doc-section-item field-body">
              <code><a class="autorefs autorefs-internal" title="            SkeletonGraph (skeleplex.graph.skeleton_graph.SkeletonGraph)" href="../../graph/skeleton_graph/#skeleplex.graph.skeleton_graph.SkeletonGraph">SkeletonGraph</a></code>
          –
          <div class="doc-md-description">
            <p>The updated skeleton graph with measurements added.</p>
          </div>
        </li>
    </ul>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>skeleplex/measurements/branches.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_measurements_from_h5_to_graph</span><span class="p">(</span><span class="n">graph_path</span><span class="p">,</span> <span class="n">input_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add measurements from HDF5 files to the skeleton graph.</span>

<span class="sd">    The slice names need to be in the format:</span>

<span class="sd">    {base}_{name}_{start_node}_{end_node}.h5</span>

<span class="sd">    Valid files are usually generated using the sample_slices_from_graph function from</span>
<span class="sd">    the SkeletonGraph class. Its highly advised to use the filtering</span>
<span class="sd">    functions first.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    graph_path : str</span>
<span class="sd">        Path to the skeleton graph JSON file.</span>
<span class="sd">    input_path : str</span>
<span class="sd">        Path to the directory containing HDF5 files with the segmented slices.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    SkeletonGraph</span>
<span class="sd">        The updated skeleton graph with measurements added.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Load skeleton graph</span>
    <span class="n">skeleton_graph</span> <span class="o">=</span> <span class="n">SkeletonGraph</span><span class="o">.</span><span class="n">from_json_file</span><span class="p">(</span><span class="n">graph_path</span><span class="p">)</span>

    <span class="c1"># Prepare attributes</span>
    <span class="n">attribute_names</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;lumen_diameter&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tissue_thickness&quot;</span><span class="p">,</span>
        <span class="s2">&quot;total_area&quot;</span><span class="p">,</span>
        <span class="s2">&quot;minor_axis&quot;</span><span class="p">,</span>
        <span class="s2">&quot;major_axis&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attribute_names</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">_sd&quot;</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attribute_names</span><span class="p">]:</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">set_edge_attributes</span><span class="p">(</span><span class="n">skeleton_graph</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span> <span class="p">{},</span> <span class="n">name</span><span class="o">=</span><span class="n">attr</span><span class="p">)</span>

    <span class="n">measurement_dicts</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">key</span><span class="p">:</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s2">&quot;lumen_diameter&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tissue_thickness&quot;</span><span class="p">,</span>
            <span class="s2">&quot;total_area&quot;</span><span class="p">,</span>
            <span class="s2">&quot;minor_axis&quot;</span><span class="p">,</span>
            <span class="s2">&quot;major_axis&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lumen_diameter_sd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tissue_thickness_sd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;total_area_sd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;minor_axis_sd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;major_axis_sd&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="c1"># Get list of HDF5 files</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.h5&quot;</span><span class="p">)]</span>
    <span class="c1"># add input path to files</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>

    <span class="c1"># Process files in parallel</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">add_file_to_graph</span><span class="p">,</span> <span class="n">files</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="c1"># Fill measurement dicts</span>
    <span class="k">for</span> <span class="p">(</span>
        <span class="n">start_node</span><span class="p">,</span>
        <span class="n">end_node</span><span class="p">,</span>
        <span class="n">lumen_diameter_mean</span><span class="p">,</span>
        <span class="n">lumen_diameter_sd</span><span class="p">,</span>
        <span class="n">tissue_thickness_mean</span><span class="p">,</span>
        <span class="n">tissue_thickness_sd</span><span class="p">,</span>
        <span class="n">total_area_mean</span><span class="p">,</span>
        <span class="n">total_area_sd</span><span class="p">,</span>
        <span class="n">minor_axis_mean</span><span class="p">,</span>
        <span class="n">minor_axis_sd</span><span class="p">,</span>
        <span class="n">major_axis_mean</span><span class="p">,</span>
        <span class="n">major_axis_sd</span><span class="p">,</span>
    <span class="p">)</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">edge</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_node</span><span class="p">,</span> <span class="n">end_node</span><span class="p">)</span>
        <span class="n">measurement_dicts</span><span class="p">[</span><span class="s2">&quot;lumen_diameter&quot;</span><span class="p">][</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">lumen_diameter_mean</span>
        <span class="n">measurement_dicts</span><span class="p">[</span><span class="s2">&quot;lumen_diameter_sd&quot;</span><span class="p">][</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">lumen_diameter_sd</span>
        <span class="n">measurement_dicts</span><span class="p">[</span><span class="s2">&quot;tissue_thickness&quot;</span><span class="p">][</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">tissue_thickness_mean</span>
        <span class="n">measurement_dicts</span><span class="p">[</span><span class="s2">&quot;tissue_thickness_sd&quot;</span><span class="p">][</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">tissue_thickness_sd</span>
        <span class="n">measurement_dicts</span><span class="p">[</span><span class="s2">&quot;total_area&quot;</span><span class="p">][</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_area_mean</span>
        <span class="n">measurement_dicts</span><span class="p">[</span><span class="s2">&quot;total_area_sd&quot;</span><span class="p">][</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_area_sd</span>
        <span class="n">measurement_dicts</span><span class="p">[</span><span class="s2">&quot;minor_axis&quot;</span><span class="p">][</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">minor_axis_mean</span>
        <span class="n">measurement_dicts</span><span class="p">[</span><span class="s2">&quot;minor_axis_sd&quot;</span><span class="p">][</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">minor_axis_sd</span>
        <span class="n">measurement_dicts</span><span class="p">[</span><span class="s2">&quot;major_axis&quot;</span><span class="p">][</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">major_axis_mean</span>
        <span class="n">measurement_dicts</span><span class="p">[</span><span class="s2">&quot;major_axis_sd&quot;</span><span class="p">][</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">major_axis_sd</span>

    <span class="c1"># Set graph attributes</span>
    <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">attr_dict</span> <span class="ow">in</span> <span class="n">measurement_dicts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">set_edge_attributes</span><span class="p">(</span><span class="n">skeleton_graph</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span> <span class="n">attr_dict</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">attr</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;save&quot;</span><span class="p">)</span>
    <span class="c1"># Save</span>
    <span class="n">skeleton_graph</span><span class="o">.</span><span class="n">to_json_file</span><span class="p">(</span><span class="n">graph_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">skeleton_graph</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="skeleplex.measurements.branches.filter_and_segment_lumen" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">filter_and_segment_lumen</span>


</h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">filter_and_segment_lumen</span><span class="p">(</span><span class="n"><a class="autorefs autorefs-internal" title="data_path (skeleplex.measurements.branches.filter_and_segment_lumen(data_path))" href="#skeleplex.measurements.branches.filter_and_segment_lumen(data_path)">data_path</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-internal" title="save_path (skeleplex.measurements.branches.filter_and_segment_lumen(save_path))" href="#skeleplex.measurements.branches.filter_and_segment_lumen(save_path)">save_path</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-internal" title="sam_checkpoint_path (skeleplex.measurements.branches.filter_and_segment_lumen(sam_checkpoint_path))" href="#skeleplex.measurements.branches.filter_and_segment_lumen(sam_checkpoint_path)">sam_checkpoint_path</a></span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-internal" title="resnet_predictor (skeleplex.measurements.branches.filter_and_segment_lumen(resnet_predictor))" href="#skeleplex.measurements.branches.filter_and_segment_lumen(resnet_predictor)">resnet_predictor</a></span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="            ResNet3ClassClassifier (skeleplex.measurements.lumen_classifier.ResNet3ClassClassifier)" href="../lumen_classifier/#skeleplex.measurements.lumen_classifier.ResNet3ClassClassifier">ResNet3ClassClassifier</a></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-internal" title="eccentricity_thresh (skeleplex.measurements.branches.filter_and_segment_lumen(eccentricity_thresh))" href="#skeleplex.measurements.branches.filter_and_segment_lumen(eccentricity_thresh)">eccentricity_thresh</a></span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-internal" title="circularity_thresh (skeleplex.measurements.branches.filter_and_segment_lumen(circularity_thresh))" href="#skeleplex.measurements.branches.filter_and_segment_lumen(circularity_thresh)">circularity_thresh</a></span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-internal" title="find_lumen (skeleplex.measurements.branches.filter_and_segment_lumen(find_lumen))" href="#skeleplex.measurements.branches.filter_and_segment_lumen(find_lumen)">find_lumen</a></span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-internal" title="sam_quality_threshold (skeleplex.measurements.branches.filter_and_segment_lumen(sam_quality_threshold))" href="#skeleplex.measurements.branches.filter_and_segment_lumen(sam_quality_threshold)">sam_quality_threshold</a></span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-internal" title="segmentation_key (skeleplex.measurements.branches.filter_and_segment_lumen(segmentation_key))" href="#skeleplex.measurements.branches.filter_and_segment_lumen(segmentation_key)">segmentation_key</a></span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></span> <span class="o">=</span> <span class="s1">&#39;segmentation&#39;</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Filter and segment the lumen in the image slices.</p>
<p>Uses the spline to seed an prompt for SAM2
https://github.com/facebookresearch/sam2/tree/main</p>
<p>And a resnet classifier to classify the slices into lumen, branches and bad.</p>
<p>By convention, the lumen is labeled as 2, the tissue as 1 and the background as 0.</p>
<p>Only the central label of the slice is considered, which is the label at the
center of the slice. If there is no central label, the slice is dropped.
If the central label is touching the border of the slice, the slice is dropped.</p>
<p>The lumen is the central "open" part of the slice, which is not
touching the border, has a low eccentricity and high circularity and is usually
characterized by a low intensity in the image. If the segmentation only covers the
lumen, find_lumen should be set to False, which will only filter the slices
based on eccentricity and circularity.</p>
<p>Eccentricity is defined as the ratio of the distance between the foci of the
ellipse and the length of the major axis. A value close to 0 indicates a circle
and a value close to 1 indicates a line. Circularity is defined as the ratio
of the area of the shape to the area of a circle with the same perimeter. A
value close to 1 indicates a circle and a value close to 0 indicates a
very irregular/bumpy shape.</p>
<p>https://en.wikipedia.org/wiki/Eccentricity_(mathematics)</p>
<p>If the segmentation covers the total diameter of the branch, thus segmenting the
lumen and the tissue, find_lumen can be set to True, which will use the spline to
seed a prompt for SAM2</p>
<p>https://github.com/facebookresearch/sam2/tree/main .</p>
<p>This will segment the branch and returns different masks, ideally one for the one
for the lumen and one for the whole branch. To classify the different masks, a
ResNet classifier is used, which is trained on the lumen, branches and bad slices.
The classifier is used to classify the lumen and branches, and the bad slices are
filtered out. The classifier needs to be trained on the lumen, branches and
bad slices.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
<h3 id="skeleplex.measurements.branches.filter_and_segment_lumen(data_path)" class="doc doc-heading doc-heading-parameter">              <b><code>data_path</code></b>
</h3>              (<code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>)
          –
          <div class="doc-md-description">
            <p>Path to the input data directory containing .h5 files.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
<h3 id="skeleplex.measurements.branches.filter_and_segment_lumen(save_path)" class="doc doc-heading doc-heading-parameter">              <b><code>save_path</code></b>
</h3>              (<code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>)
          –
          <div class="doc-md-description">
            <p>Path to the output directory where filtered .h5 files will be saved.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
<h3 id="skeleplex.measurements.branches.filter_and_segment_lumen(sam_checkpoint_path)" class="doc doc-heading doc-heading-parameter">              <b><code>sam_checkpoint_path</code></b>
</h3>              (<code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>, default:
                  <code>None</code>
)
          –
          <div class="doc-md-description">
            <p>Path to the SAM2 checkpoint file.
only required if find_lumen is True.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
<h3 id="skeleplex.measurements.branches.filter_and_segment_lumen(resnet_predictor)" class="doc doc-heading doc-heading-parameter">              <b><code>resnet_predictor</code></b>
</h3>              (<code><a class="autorefs autorefs-internal" title="            ResNet3ClassClassifier (skeleplex.measurements.lumen_classifier.ResNet3ClassClassifier)" href="../lumen_classifier/#skeleplex.measurements.lumen_classifier.ResNet3ClassClassifier">ResNet3ClassClassifier</a></code>, default:
                  <code>None</code>
)
          –
          <div class="doc-md-description">
            <p>ResNet classifier for predicting classes.
Only required if find_lumen is True.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
<h3 id="skeleplex.measurements.branches.filter_and_segment_lumen(eccentricity_thresh)" class="doc doc-heading doc-heading-parameter">              <b><code>eccentricity_thresh</code></b>
</h3>              (<code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>, default:
                  <code>0.7</code>
)
          –
          <div class="doc-md-description">
            <p>Eccentricity threshold for filtering slices.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
<h3 id="skeleplex.measurements.branches.filter_and_segment_lumen(circularity_thresh)" class="doc doc-heading doc-heading-parameter">              <b><code>circularity_thresh</code></b>
</h3>              (<code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>, default:
                  <code>0.5</code>
)
          –
          <div class="doc-md-description">
            <p>Circularity threshold for filtering slices.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
<h3 id="skeleplex.measurements.branches.filter_and_segment_lumen(find_lumen)" class="doc doc-heading doc-heading-parameter">              <b><code>find_lumen</code></b>
</h3>              (<code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>, default:
                  <code>True</code>
)
          –
          <div class="doc-md-description">
            <p>Whether to find the lumen using SAM2 or just to filter for
eccentricity and circularity.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
<h3 id="skeleplex.measurements.branches.filter_and_segment_lumen(sam_quality_threshold)" class="doc doc-heading doc-heading-parameter">              <b><code>sam_quality_threshold</code></b>
</h3>              (<code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>, default:
                  <code>0.1</code>
)
          –
          <div class="doc-md-description">
            <p>Minimum SAM quality score to consider a mask for classification.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
<h3 id="skeleplex.measurements.branches.filter_and_segment_lumen(segmentation_key)" class="doc doc-heading doc-heading-parameter">              <b><code>segmentation_key</code></b>
</h3>              (<code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>, default:
                  <code>&#39;segmentation&#39;</code>
)
          –
          <div class="doc-md-description">
            <p>The h5 dataset key to use for the segmentation slices.</p>
          </div>
        </li>
    </ul>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>skeleplex/measurements/branches.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">filter_and_segment_lumen</span><span class="p">(</span>
    <span class="n">data_path</span><span class="p">,</span>
    <span class="n">save_path</span><span class="p">,</span>
    <span class="n">sam_checkpoint_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">resnet_predictor</span><span class="p">:</span> <span class="s2">&quot;ResNet3ClassClassifier | None&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">eccentricity_thresh</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
    <span class="n">circularity_thresh</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">find_lumen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">sam_quality_threshold</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">segmentation_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;segmentation&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter and segment the lumen in the image slices.</span>

<span class="sd">    Uses the spline to seed an prompt for SAM2</span>
<span class="sd">    https://github.com/facebookresearch/sam2/tree/main</span>

<span class="sd">    And a resnet classifier to classify the slices into lumen, branches and bad.</span>

<span class="sd">    By convention, the lumen is labeled as 2, the tissue as 1 and the background as 0.</span>

<span class="sd">    Only the central label of the slice is considered, which is the label at the</span>
<span class="sd">    center of the slice. If there is no central label, the slice is dropped.</span>
<span class="sd">    If the central label is touching the border of the slice, the slice is dropped.</span>

<span class="sd">    The lumen is the central &quot;open&quot; part of the slice, which is not</span>
<span class="sd">    touching the border, has a low eccentricity and high circularity and is usually</span>
<span class="sd">    characterized by a low intensity in the image. If the segmentation only covers the</span>
<span class="sd">    lumen, find_lumen should be set to False, which will only filter the slices</span>
<span class="sd">    based on eccentricity and circularity.</span>

<span class="sd">    Eccentricity is defined as the ratio of the distance between the foci of the</span>
<span class="sd">    ellipse and the length of the major axis. A value close to 0 indicates a circle</span>
<span class="sd">    and a value close to 1 indicates a line. Circularity is defined as the ratio</span>
<span class="sd">    of the area of the shape to the area of a circle with the same perimeter. A</span>
<span class="sd">    value close to 1 indicates a circle and a value close to 0 indicates a</span>
<span class="sd">    very irregular/bumpy shape.</span>

<span class="sd">    https://en.wikipedia.org/wiki/Eccentricity_(mathematics)</span>


<span class="sd">    If the segmentation covers the total diameter of the branch, thus segmenting the</span>
<span class="sd">    lumen and the tissue, find_lumen can be set to True, which will use the spline to</span>
<span class="sd">    seed a prompt for SAM2</span>

<span class="sd">    https://github.com/facebookresearch/sam2/tree/main .</span>

<span class="sd">    This will segment the branch and returns different masks, ideally one for the one</span>
<span class="sd">    for the lumen and one for the whole branch. To classify the different masks, a</span>
<span class="sd">    ResNet classifier is used, which is trained on the lumen, branches and bad slices.</span>
<span class="sd">    The classifier is used to classify the lumen and branches, and the bad slices are</span>
<span class="sd">    filtered out. The classifier needs to be trained on the lumen, branches and</span>
<span class="sd">    bad slices.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_path : str</span>
<span class="sd">        Path to the input data directory containing .h5 files.</span>
<span class="sd">    save_path : str</span>
<span class="sd">        Path to the output directory where filtered .h5 files will be saved.</span>
<span class="sd">    sam_checkpoint_path : str, optional</span>
<span class="sd">        Path to the SAM2 checkpoint file.</span>
<span class="sd">        only required if find_lumen is True.</span>
<span class="sd">    resnet_predictor : ResNet3ClassClassifier, optional</span>
<span class="sd">        ResNet classifier for predicting classes.</span>
<span class="sd">        Only required if find_lumen is True.</span>
<span class="sd">    eccentricity_thresh : float</span>
<span class="sd">        Eccentricity threshold for filtering slices.</span>
<span class="sd">    circularity_thresh : float</span>
<span class="sd">        Circularity threshold for filtering slices.</span>
<span class="sd">    find_lumen : bool</span>
<span class="sd">        Whether to find the lumen using SAM2 or just to filter for</span>
<span class="sd">        eccentricity and circularity.</span>
<span class="sd">    sam_quality_threshold : float</span>
<span class="sd">        Minimum SAM quality score to consider a mask for classification.</span>
<span class="sd">    segmentation_key : str</span>
<span class="sd">        The h5 dataset key to use for the segmentation slices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created directory: </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.h5&quot;</span><span class="p">)]</span>
    <span class="c1"># only do those that are npot in the save_path</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s2"> files to process.&quot;</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing files&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">file</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">image_slices</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">][:]</span>
            <span class="n">segmentation_slices</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">segmentation_key</span><span class="p">][:]</span> <span class="o">!=</span> <span class="mi">0</span>

        <span class="n">label_slices_filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">segmentation_slices</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">index_to_remove</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">image_slices</span><span class="p">)):</span>
            <span class="n">image_slice</span> <span class="o">=</span> <span class="n">image_slices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">segmentation_slice</span> <span class="o">=</span> <span class="n">segmentation_slices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">label_slice</span> <span class="o">=</span> <span class="n">ski</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">segmentation_slice</span><span class="p">)</span>
            <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">image_slice</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">central_label</span> <span class="o">=</span> <span class="n">label_slice</span><span class="p">[</span><span class="n">h</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">w</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span>

            <span class="c1"># Skip if no central label</span>
            <span class="k">if</span> <span class="n">central_label</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">index_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Remove if touching the border</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">label_slice</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="n">central_label</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">label_slice</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="n">central_label</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">label_slice</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">central_label</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">label_slice</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">central_label</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">index_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">label_slice</span><span class="p">[</span><span class="n">label_slice</span> <span class="o">!=</span> <span class="n">central_label</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">label_slice</span><span class="p">[</span><span class="n">label_slice</span> <span class="o">==</span> <span class="n">central_label</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="c1"># Check eccentricity</span>
            <span class="n">props</span> <span class="o">=</span> <span class="n">ski</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">regionprops</span><span class="p">(</span><span class="n">label_slice</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">props</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">eccentricity</span> <span class="o">&gt;</span> <span class="n">eccentricity_thresh</span><span class="p">:</span>
                <span class="n">index_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Check circularity</span>
            <span class="n">circularity</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">props</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="p">(</span><span class="n">props</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">perimeter</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">circularity</span> <span class="o">&lt;</span> <span class="n">circularity_thresh</span><span class="p">:</span>
                <span class="n">index_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">find_lumen</span><span class="p">:</span>
                <span class="c1"># delay imports so that the function can be used without SAM2</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">sam2.build_sam</span><span class="w"> </span><span class="kn">import</span> <span class="n">build_sam2</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">sam2.sam2_image_predictor</span><span class="w"> </span><span class="kn">import</span> <span class="n">SAM2ImagePredictor</span>

                <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
                <span class="n">sam2_checkpoint</span> <span class="o">=</span> <span class="n">sam_checkpoint_path</span>
                <span class="n">model_cfg</span> <span class="o">=</span> <span class="s2">&quot;configs/sam2.1/sam2.1_hiera_l.yaml&quot;</span>
                <span class="n">sam2_model</span> <span class="o">=</span> <span class="n">build_sam2</span><span class="p">(</span><span class="n">model_cfg</span><span class="p">,</span> <span class="n">sam2_checkpoint</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
                <span class="n">predictor</span> <span class="o">=</span> <span class="n">SAM2ImagePredictor</span><span class="p">(</span><span class="n">sam2_model</span><span class="p">)</span>

                <span class="n">label_slice</span> <span class="o">=</span> <span class="n">find_lumen_in_slice</span><span class="p">(</span>
                    <span class="n">image_slice</span><span class="p">,</span>
                    <span class="n">label_slice</span><span class="p">,</span>
                    <span class="n">predictor</span><span class="p">,</span>
                    <span class="n">resnet_predictor</span><span class="p">,</span>
                    <span class="n">sam_quality_threshold</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">label_slices_filt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">label_slice</span>

        <span class="c1"># Remove invalid slices</span>
        <span class="n">image_slice_filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">image_slices</span><span class="p">,</span> <span class="n">index_to_remove</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">label_slices_filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">label_slices_filt</span><span class="p">,</span> <span class="n">index_to_remove</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">file</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">image_slice_filt</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;segmentation&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">label_slices_filt</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="skeleplex.measurements.branches.filter_file_for_iterative_lumens" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">filter_file_for_iterative_lumens</span>


</h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">filter_file_for_iterative_lumens</span><span class="p">(</span><span class="n"><a class="autorefs autorefs-internal" title="args (skeleplex.measurements.branches.filter_file_for_iterative_lumens(args))" href="#skeleplex.measurements.branches.filter_file_for_iterative_lumens(args)">args</a></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Filter a single HDF5 file for iterative lumens.</p>
<p>This function processes a single HDF5 file, filtering out slices that do not
contain the iterative lumen label (2). It checks each slice in the segmentation
data and removes slices that do not contain label 2, or are not surrounded by
label 2 slices. The filtered slices are saved to the specified output path.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
<h3 id="skeleplex.measurements.branches.filter_file_for_iterative_lumens(args)" class="doc doc-heading doc-heading-parameter">              <b><code>args</code></b>
</h3>              (<code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a></code>)
          –
          <div class="doc-md-description">
            <p>A tuple containing the file name, data path, and save path.
The tuple should be in the format (file_name, data_path, save_path).</p>
          </div>
        </li>
    </ul>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>skeleplex/measurements/branches.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">filter_file_for_iterative_lumens</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter a single HDF5 file for iterative lumens.</span>

<span class="sd">    This function processes a single HDF5 file, filtering out slices that do not</span>
<span class="sd">    contain the iterative lumen label (2). It checks each slice in the segmentation</span>
<span class="sd">    data and removes slices that do not contain label 2, or are not surrounded by</span>
<span class="sd">    label 2 slices. The filtered slices are saved to the specified output path.</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    args : tuple</span>
<span class="sd">        A tuple containing the file name, data path, and save path.</span>
<span class="sd">        The tuple should be in the format (file_name, data_path, save_path).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file</span><span class="p">,</span> <span class="n">data_path</span><span class="p">,</span> <span class="n">save_path</span> <span class="o">=</span> <span class="n">args</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">input_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
    <span class="n">output_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">input_file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">image_slices</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">][:]</span>
            <span class="n">segmentation_slices</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;segmentation&quot;</span><span class="p">][:]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">segmentation_slices</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No label 2 in file </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">, skipping.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">index_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label_slice</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">segmentation_slices</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">segmentation_slices</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">label_slice</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">segmentation_slices</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">segmentation_slices</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="n">index_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">index_to_remove</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No slices to remove in file </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">image_slice_filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">image_slices</span><span class="p">,</span> <span class="n">index_to_remove</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">label_slices_filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">segmentation_slices</span><span class="p">,</span> <span class="n">index_to_remove</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">output_file_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">image_slice_filt</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;segmentation&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">label_slices_filt</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtered and saved </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="skeleplex.measurements.branches.filter_for_iterative_lumens" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">filter_for_iterative_lumens</span>


</h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">filter_for_iterative_lumens</span><span class="p">(</span><span class="n"><a class="autorefs autorefs-internal" title="data_path (skeleplex.measurements.branches.filter_for_iterative_lumens(data_path))" href="#skeleplex.measurements.branches.filter_for_iterative_lumens(data_path)">data_path</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-internal" title="save_path (skeleplex.measurements.branches.filter_for_iterative_lumens(save_path))" href="#skeleplex.measurements.branches.filter_for_iterative_lumens(save_path)">save_path</a></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Filter for iterative lumens across multiple files in parallel.</p>
<p>This function processes HDF5 files in the specified data path, filtering out slices
that do not contain the iterative lumen label (2). It removes slices that are not
part of the iterative lumen by checking if the label 2 is present in the
segmentation slices. If a slice does not contain label 2, it checks the neighboring
slices to determine if it should be removed.
The filtered slices are saved to the specified save path.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
<h3 id="skeleplex.measurements.branches.filter_for_iterative_lumens(data_path)" class="doc doc-heading doc-heading-parameter">              <b><code>data_path</code></b>
</h3>              (<code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>)
          –
          <div class="doc-md-description">
            <p>Path to the input data directory containing .h5 files.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
<h3 id="skeleplex.measurements.branches.filter_for_iterative_lumens(save_path)" class="doc doc-heading doc-heading-parameter">              <b><code>save_path</code></b>
</h3>              (<code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>)
          –
          <div class="doc-md-description">
            <p>Path to the output directory where filtered .h5 files will be saved.</p>
          </div>
        </li>
    </ul>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>skeleplex/measurements/branches.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">filter_for_iterative_lumens</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">save_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter for iterative lumens across multiple files in parallel.</span>

<span class="sd">    This function processes HDF5 files in the specified data path, filtering out slices</span>
<span class="sd">    that do not contain the iterative lumen label (2). It removes slices that are not</span>
<span class="sd">    part of the iterative lumen by checking if the label 2 is present in the</span>
<span class="sd">    segmentation slices. If a slice does not contain label 2, it checks the neighboring</span>
<span class="sd">    slices to determine if it should be removed.</span>
<span class="sd">    The filtered slices are saved to the specified save path.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_path : str</span>
<span class="sd">        Path to the input data directory containing .h5 files.</span>
<span class="sd">    save_path : str</span>
<span class="sd">        Path to the output directory where filtered .h5 files will be saved.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created directory: </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.h5&quot;</span><span class="p">)]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s2"> files to process.&quot;</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing files&quot;</span><span class="p">)</span>

    <span class="c1"># Pack arguments for parallel processing</span>
    <span class="n">file_args</span> <span class="o">=</span> <span class="p">[(</span><span class="n">f</span><span class="p">,</span> <span class="n">data_path</span><span class="p">,</span> <span class="n">save_path</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>

    <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="nb">list</span><span class="p">(</span><span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">filter_file_for_iterative_lumens</span><span class="p">,</span> <span class="n">file_args</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="skeleplex.measurements.branches.find_lumen_in_slice" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">find_lumen_in_slice</span>


</h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">find_lumen_in_slice</span><span class="p">(</span><span class="n"><span title="skeleplex.measurements.branches.find_lumen_in_slice(image_slice)">image_slice</span></span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" title="numpy.ndarray" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray">ndarray</a></span><span class="p">,</span> <span class="n"><span title="skeleplex.measurements.branches.find_lumen_in_slice(label_slice)">label_slice</span></span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" title="numpy.ndarray" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray">ndarray</a></span><span class="p">,</span> <span class="n"><span title="skeleplex.measurements.branches.find_lumen_in_slice(predictor)">predictor</span></span><span class="p">:</span> <span class="n"><span title="sam2.sam2_image_predictor.SAM2ImagePredictor">SAM2ImagePredictor</span></span><span class="p">,</span> <span class="n"><span title="skeleplex.measurements.branches.find_lumen_in_slice(resnet_predictor)">resnet_predictor</span></span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="            ResNet3ClassClassifier (skeleplex.measurements.lumen_classifier.ResNet3ClassClassifier)" href="../lumen_classifier/#skeleplex.measurements.lumen_classifier.ResNet3ClassClassifier">ResNet3ClassClassifier</a></span><span class="p">,</span> <span class="n"><span title="skeleplex.measurements.branches.find_lumen_in_slice(sam_quality_threshold)">sam_quality_threshold</span></span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-external" title="numpy.ndarray" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray">ndarray</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Find lumen and branch labels in a single 2D image slice.</p>
<p>Uses a SAM-based segmentation followed by a ResNet-based mask classifier.
This function performs the following high-level steps:
1. Converts the grayscale image slice to RGB and runs the provided SAM predictor
    with a single central point to obtain up to three candidate masks and
    associated quality scores.
2. For each SAM mask, creates a masked image (image * mask), crops it to the
    mask's bounding box, and sends the cropped mask image to the provided
    resnet_predictor to obtain a predicted class and confidence.
3. Builds a new label image where:
    - label value 0 denotes background,
    - label value 1 denotes branch tissue,
    - label value 2 denotes lumen.
    Classification decisions follow these rules:
    - Only masks with SAM quality &gt; 0.1 are passed to the ResNet classifier.
    - If no masks pass the quality threshold, the original label_slice is
        returned unchanged.
    - If one or more masks are predicted as lumen (class 0), the highest-quality
        lumen mask is used to mark lumen (value 2). If that lumen mask touches the
        background (according to lumen_touches_background) and another lumen mask
        exists, the second-best lumen mask will be tried.
    - Branch masks (class 1) are chosen by quality. If the best class-1 mask has
        quality &lt; 0.5, branch pixels are copied from the original segmentation;
        otherwise the SAM class-1 mask is used for branch labeling.
    - If all candidate predictions are class 2 (non-lumen, non-branch), or if
        the final lumen segmentation touches the background, the original
        segmentation is returned.
4. Returns the label slice updated with lumen and branch annotations.</p>


<details class="parameters." open>
  <summary>Parameters.</summary>
  <p>image_slice : numpy.ndarray
        2D grayscale image array for the current slice (H x W).
label_slice : numpy.ndarray
        2D integer label array for the current slice (H x W). Non-zero values are
        considered tissue/structures that can be re-assigned to branch (1) or
        lumen (2).
predictor : object
        SAM predictor instance providing:
        - set_image(image_rgb) to set the image,
        - predict(point_coords, point_labels, multimask_output=True) to return
            (masks, scores, ...) where masks is an array-like of binary masks and
            scores (sam_quality) is an array-like of quality values.
resnet_predictor : object
        Classifier for cropped mask images. Must implement:
        - predict(cropped_mask_image) -&gt; (pred_class, confidence)
        Where pred_class is an integer code (0 for lumen, 1 for branch, 2 for other)
        and confidence is a float confidence score.
sam_quality_threshold : float
        Minimum SAM quality score to consider a mask for classification.</p>
</details>

<p><span class="doc-section-title">Returns:</span></p>
    <ul>
        <li class="doc-section-item field-body">
              <code><a class="autorefs autorefs-external" title="numpy.ndarray" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray">ndarray</a></code>
          –
          <div class="doc-md-description">
            <p>A 2D label array (same shape as label_slice) where lumen pixels are set to
2, branch pixels to 1, and background to 0. In cases where SAM/resnet-based
postprocessing is deemed unreliable, the original label_slice is returned
unchanged.</p>
          </div>
        </li>
    </ul>


<details class="note" open>
  <summary>Notes</summary>
  <ul>
<li>The behavior and thresholds (SAM quality &gt; 0.1 to classify, class-1 quality
    threshold 0.5) are tuned heuristics that can be adjusted if needed.</li>
</ul>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>skeleplex/measurements/branches.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find_lumen_in_slice</span><span class="p">(</span>
    <span class="n">image_slice</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">label_slice</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">predictor</span><span class="p">:</span> <span class="s2">&quot;SAM2ImagePredictor&quot;</span><span class="p">,</span>
    <span class="n">resnet_predictor</span><span class="p">:</span> <span class="s2">&quot;ResNet3ClassClassifier&quot;</span><span class="p">,</span>
    <span class="n">sam_quality_threshold</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find lumen and branch labels in a single 2D image slice.</span>

<span class="sd">    Uses a SAM-based segmentation followed by a ResNet-based mask classifier.</span>
<span class="sd">    This function performs the following high-level steps:</span>
<span class="sd">    1. Converts the grayscale image slice to RGB and runs the provided SAM predictor</span>
<span class="sd">        with a single central point to obtain up to three candidate masks and</span>
<span class="sd">        associated quality scores.</span>
<span class="sd">    2. For each SAM mask, creates a masked image (image * mask), crops it to the</span>
<span class="sd">        mask&#39;s bounding box, and sends the cropped mask image to the provided</span>
<span class="sd">        resnet_predictor to obtain a predicted class and confidence.</span>
<span class="sd">    3. Builds a new label image where:</span>
<span class="sd">        - label value 0 denotes background,</span>
<span class="sd">        - label value 1 denotes branch tissue,</span>
<span class="sd">        - label value 2 denotes lumen.</span>
<span class="sd">        Classification decisions follow these rules:</span>
<span class="sd">        - Only masks with SAM quality &gt; 0.1 are passed to the ResNet classifier.</span>
<span class="sd">        - If no masks pass the quality threshold, the original label_slice is</span>
<span class="sd">            returned unchanged.</span>
<span class="sd">        - If one or more masks are predicted as lumen (class 0), the highest-quality</span>
<span class="sd">            lumen mask is used to mark lumen (value 2). If that lumen mask touches the</span>
<span class="sd">            background (according to lumen_touches_background) and another lumen mask</span>
<span class="sd">            exists, the second-best lumen mask will be tried.</span>
<span class="sd">        - Branch masks (class 1) are chosen by quality. If the best class-1 mask has</span>
<span class="sd">            quality &lt; 0.5, branch pixels are copied from the original segmentation;</span>
<span class="sd">            otherwise the SAM class-1 mask is used for branch labeling.</span>
<span class="sd">        - If all candidate predictions are class 2 (non-lumen, non-branch), or if</span>
<span class="sd">            the final lumen segmentation touches the background, the original</span>
<span class="sd">            segmentation is returned.</span>
<span class="sd">    4. Returns the label slice updated with lumen and branch annotations.</span>
<span class="sd">    Parameters.</span>
<span class="sd">    ----------</span>
<span class="sd">    image_slice : numpy.ndarray</span>
<span class="sd">            2D grayscale image array for the current slice (H x W).</span>
<span class="sd">    label_slice : numpy.ndarray</span>
<span class="sd">            2D integer label array for the current slice (H x W). Non-zero values are</span>
<span class="sd">            considered tissue/structures that can be re-assigned to branch (1) or</span>
<span class="sd">            lumen (2).</span>
<span class="sd">    predictor : object</span>
<span class="sd">            SAM predictor instance providing:</span>
<span class="sd">            - set_image(image_rgb) to set the image,</span>
<span class="sd">            - predict(point_coords, point_labels, multimask_output=True) to return</span>
<span class="sd">                (masks, scores, ...) where masks is an array-like of binary masks and</span>
<span class="sd">                scores (sam_quality) is an array-like of quality values.</span>
<span class="sd">    resnet_predictor : object</span>
<span class="sd">            Classifier for cropped mask images. Must implement:</span>
<span class="sd">            - predict(cropped_mask_image) -&gt; (pred_class, confidence)</span>
<span class="sd">            Where pred_class is an integer code (0 for lumen, 1 for branch, 2 for other)</span>
<span class="sd">            and confidence is a float confidence score.</span>
<span class="sd">    sam_quality_threshold : float</span>
<span class="sd">            Minimum SAM quality score to consider a mask for classification.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.ndarray</span>
<span class="sd">            A 2D label array (same shape as label_slice) where lumen pixels are set to</span>
<span class="sd">            2, branch pixels to 1, and background to 0. In cases where SAM/resnet-based</span>
<span class="sd">            postprocessing is deemed unreliable, the original label_slice is returned</span>
<span class="sd">            unchanged.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - The behavior and thresholds (SAM quality &gt; 0.1 to classify, class-1 quality</span>
<span class="sd">        threshold 0.5) are tuned heuristics that can be adjusted if needed.</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Segment using SAM2</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">image_slice</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">image_slice_rgb</span> <span class="o">=</span> <span class="n">grey2rgb</span><span class="p">(</span><span class="n">image_slice</span><span class="p">)</span>
    <span class="n">predictor</span><span class="o">.</span><span class="n">set_image</span><span class="p">(</span><span class="n">image_slice_rgb</span><span class="p">)</span>
    <span class="n">sam_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">h</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">w</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]])</span>
    <span class="n">sam_label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">sam_mask</span><span class="p">,</span> <span class="n">sam_quality</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">point_coords</span><span class="o">=</span><span class="n">sam_point</span><span class="p">,</span>
        <span class="n">point_labels</span><span class="o">=</span><span class="n">sam_label</span><span class="p">,</span>
        <span class="n">multimask_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">mask_img1</span> <span class="o">=</span> <span class="n">image_slice</span> <span class="o">*</span> <span class="n">sam_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">mask_img2</span> <span class="o">=</span> <span class="n">image_slice</span> <span class="o">*</span> <span class="n">sam_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">mask_img3</span> <span class="o">=</span> <span class="n">image_slice</span> <span class="o">*</span> <span class="n">sam_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># crop to bounding box</span>
    <span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">ski</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">regionprops</span><span class="p">(</span><span class="n">sam_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))[</span>
        <span class="mi">0</span>
    <span class="p">]</span><span class="o">.</span><span class="n">bbox</span>
    <span class="n">mask_img1</span> <span class="o">=</span> <span class="n">mask_img1</span><span class="p">[</span><span class="n">min_x</span><span class="p">:</span><span class="n">max_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">:</span><span class="n">max_y</span><span class="p">]</span>

    <span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">ski</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">regionprops</span><span class="p">(</span><span class="n">sam_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))[</span>
        <span class="mi">0</span>
    <span class="p">]</span><span class="o">.</span><span class="n">bbox</span>
    <span class="n">mask_img2</span> <span class="o">=</span> <span class="n">mask_img2</span><span class="p">[</span><span class="n">min_x</span><span class="p">:</span><span class="n">max_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">:</span><span class="n">max_y</span><span class="p">]</span>

    <span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">ski</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">regionprops</span><span class="p">(</span><span class="n">sam_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))[</span>
        <span class="mi">0</span>
    <span class="p">]</span><span class="o">.</span><span class="n">bbox</span>
    <span class="n">mask_img3</span> <span class="o">=</span> <span class="n">mask_img3</span><span class="p">[</span><span class="n">min_x</span><span class="p">:</span><span class="n">max_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">:</span><span class="n">max_y</span><span class="p">]</span>

    <span class="n">label_with_lumen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">label_slice</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mask_imgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">mask_img1</span><span class="p">,</span> <span class="n">mask_img2</span><span class="p">,</span> <span class="n">mask_img3</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">mask_img</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mask_imgs</span><span class="p">):</span>
        <span class="c1"># Only classify if SAM mask quality is above threshold</span>
        <span class="k">if</span> <span class="n">sam_quality</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sam_quality_threshold</span><span class="p">:</span>
            <span class="n">pred_class</span><span class="p">,</span> <span class="n">conf</span> <span class="o">=</span> <span class="n">resnet_predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">mask_img</span><span class="p">)</span>
            <span class="n">preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">j</span><span class="p">,</span>
                    <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="n">pred_class</span><span class="p">,</span>
                    <span class="s2">&quot;conf&quot;</span><span class="p">:</span> <span class="n">conf</span><span class="p">,</span>
                    <span class="s2">&quot;quality&quot;</span><span class="p">:</span> <span class="n">sam_quality</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Skipping SAM mask </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="sa">f</span><span class="s2">&quot;due to low quality (</span><span class="si">{</span><span class="n">sam_quality</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

    <span class="c1"># If no good-quality masks, fall back to original segmentation</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">preds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No SAM masks with quality &gt; 0.5,&quot;</span> <span class="s2">&quot;using original segmentation.&quot;</span><span class="p">)</span>
        <span class="n">label_with_lumen</span> <span class="o">=</span> <span class="n">label_slice</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">([</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;class&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">preds</span><span class="p">])</span>

        <span class="c1"># Handle lumen (class 0)</span>
        <span class="n">lumen_preds</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">preds</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;class&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">lumen_preds</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found lumen&quot;</span><span class="p">)</span>
            <span class="n">best_lumen</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lumen_preds</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;quality&quot;</span><span class="p">])</span>
            <span class="n">label_with_lumen</span><span class="p">[</span><span class="n">sam_mask</span><span class="p">[</span><span class="n">best_lumen</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="c1"># Handle branches (class 1)</span>
        <span class="n">class1_preds</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">preds</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;class&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">class1_preds</span><span class="p">:</span>
            <span class="n">best_class1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">class1_preds</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;quality&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">best_class1</span><span class="p">[</span><span class="s2">&quot;quality&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Low quality for class 1 mask,&quot;</span>
                    <span class="s2">&quot;assigning class 1 to original segmentation&quot;</span>
                <span class="p">)</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">label_slice</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">label_with_lumen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">label_with_lumen</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">sam_mask</span><span class="p">[</span><span class="n">best_class1</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">label_with_lumen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">label_with_lumen</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If no class 1 was found, use original segmentation</span>
            <span class="n">label_with_lumen</span><span class="p">[(</span><span class="n">label_slice</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">label_with_lumen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Handle case where all are bad (class 2)</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;class&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">preds</span><span class="p">):</span>
            <span class="n">label_with_lumen</span> <span class="o">=</span> <span class="n">label_slice</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lumen_touches_background</span><span class="p">(</span><span class="n">label_with_lumen</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Lumen touches background,&quot;</span> <span class="s2">&quot;reverting to original segmentation.&quot;</span>
            <span class="p">)</span>
            <span class="n">label_with_lumen</span> <span class="o">=</span> <span class="n">label_slice</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">label_slice</span> <span class="o">=</span> <span class="n">label_with_lumen</span>
    <span class="k">return</span> <span class="n">label_slice</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="skeleplex.measurements.branches.fix_only_lumen" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">fix_only_lumen</span>


</h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">fix_only_lumen</span><span class="p">(</span><span class="n"><span title="skeleplex.measurements.branches.fix_only_lumen(segmentation_slice)">segmentation_slice</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Fix segmentation slices containing only lumen.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>skeleplex/measurements/branches.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fix_only_lumen</span><span class="p">(</span><span class="n">segmentation_slice</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fix segmentation slices containing only lumen.&quot;&quot;&quot;</span>
    <span class="n">boundary_lumen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
        <span class="nb">map</span><span class="p">(</span>
            <span class="nb">tuple</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">ski</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">find_contours</span><span class="p">(</span><span class="n">segmentation_slice</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
            <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">boundary_background</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
        <span class="nb">map</span><span class="p">(</span>
            <span class="nb">tuple</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">ski</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">find_contours</span><span class="p">(</span><span class="n">segmentation_slice</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
            <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">boundary_lumen</span> <span class="o">&amp;</span> <span class="n">boundary_background</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="skeleplex.measurements.branches.lumen_touches_background" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">lumen_touches_background</span>


</h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">lumen_touches_background</span><span class="p">(</span><span class="n"><a class="autorefs autorefs-internal" title="label_slice (skeleplex.measurements.branches.lumen_touches_background(label_slice))" href="#skeleplex.measurements.branches.lumen_touches_background(label_slice)">label_slice</a></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Check if lumen touches background in a label slice.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
<h3 id="skeleplex.measurements.branches.lumen_touches_background(label_slice)" class="doc doc-heading doc-heading-parameter">              <b><code>label_slice</code></b>
</h3>              (<code><a class="autorefs autorefs-external" title="numpy.ndarray" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray">ndarray</a></code>)
          –
          <div class="doc-md-description">
            <p>2D array representing the label slice.</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Returns:</span></p>
    <ul>
        <li class="doc-section-item field-body">
              <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
          –
          <div class="doc-md-description">
            <p>True if lumen touches background, False otherwise.</p>
          </div>
        </li>
    </ul>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>skeleplex/measurements/branches.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">lumen_touches_background</span><span class="p">(</span><span class="n">label_slice</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if lumen touches background in a label slice.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    label_slice : numpy.ndarray</span>
<span class="sd">        2D array representing the label slice.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True if lumen touches background, False otherwise.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lumen_label</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">background_label</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">lumen_mask</span> <span class="o">=</span> <span class="n">label_slice</span> <span class="o">==</span> <span class="n">lumen_label</span>
    <span class="n">background_mask</span> <span class="o">=</span> <span class="n">label_slice</span> <span class="o">==</span> <span class="n">background_label</span>
    <span class="c1"># Dilate lumen mask to ensure touching</span>
    <span class="n">dilated_lumen</span> <span class="o">=</span> <span class="n">binary_dilation</span><span class="p">(</span><span class="n">lumen_mask</span><span class="p">,</span> <span class="n">footprint</span><span class="o">=</span><span class="n">disk</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">touching</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">dilated_lumen</span> <span class="o">&amp;</span> <span class="n">background_mask</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">touching</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../../..", "features": ["search.highlight", "search.suggest", "content.code.copy", "content.code.annotate", "toc.follow"], "search": "../../../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>